<?php
ob_start();
session_start();

if (!$_SESSION['u']) {
    header('location:login.php');
}
include("./config/connection.php");

if (isset($_POST['post'])) {
    $name = mysqli_real_escape_string($con, $_POST['name']);
    $position = mysqli_real_escape_string($con, $_POST['position']);
    $email = mysqli_real_escape_string($con, $_POST['email']);

    // CV upload
    $targetDirCv = "upload/cvs/";
    $fileNameCv = uniqid() . '_' . basename($_FILES['cv']['name']); // Generate a unique filename
    $targetFilePathCv = $targetDirCv . $fileNameCv; // Final file path

    // Check file size (in bytes)
    $maxFileSizeCv = 1 * 1024 * 1024;
    if ($_FILES["cv"]["size"] > $maxFileSizeCv) {
        echo "<script>alert('Error: CV size exceeds 1 MB limit.');</script>";
        // You can add additional JavaScript code or remove the exit() statement
        // exit();
    }

    // File Upload
    $targetDir = "upload/teachers/"; // Specify the target directory
    $fileName = uniqid() . '_' . basename($_FILES["img"]["name"]); // Generate a unique filename
    $targetFilePath = $targetDir . $fileName; // Final file path

    // Check file size (in bytes)
    $maxFileSize = 1048576; // 1 MB
    if ($_FILES["img"]["size"] > $maxFileSize) {
        echo "<script>alert('Error: File size exceeds 1 MB limit.');</script>";
        // You can add additional JavaScript code or remove the exit() statement
        // exit();
    }

    if (file_exists($targetFilePath)) {
        echo "<script>alert('Error: File already exists.');</script>";
        // You can add additional JavaScript code or remove the exit() statement
        // exit();
    }

    // Upload file
    if (move_uploaded_file($_FILES["img"]["tmp_name"], $targetFilePath)) {
        // Now upload cv
        if (move_uploaded_file($_FILES["cv"]["tmp_name"], $targetFilePathCv)) {
            // File upload success, now insert data into the database
            $sql = "INSERT INTO `faculty_members`(`name`, `photo`, `email`, `position`, `cv_path`) VALUES ('$name','$targetFilePath','$email','$position','$targetFilePathCv')";
            // Perform the database operation within a try-catch block
            try {
                $run = mysqli_query($con, $sql);

                if ($run) {
                    echo "<script>alert('Teacher Profile is successfully added.'); window.location.href='addteacher.php?a=1';</script>";
                } else {
                    echo "<script>alert('Error: Please fill in correct data.');</script>";
                }
            } catch (mysqli_sql_exception $e) {
                // Check if the error code indicates a duplicate entry
                if ($e->getCode() == 1062) { // MySQL error code for duplicate entry
                    echo "<script>alert('Error: Duplicate email. Please enter unique email.');</script>";
                } else {
                    echo "<script>alert('Error: " . $e->getMessage() . "');</script>";
                }
            }
        } else {
            echo "<script>alert('Error uploading the CV.');</script>";
        }
    } else {
        echo "<script>alert('Error uploading the file.');</script>";
    }
}
?>

<?php include_once("include1/sidenav.php"); ?>
<!-- ====================================
      ——— PAGE WRAPPER
      ===================================== -->
<div class="page-wrapper">
    <?php include_once("include1/header.php"); ?>
    <!-- ====================================
        ——— CONTENT WRAPPER
        ===================================== -->
    <div class="container">
        <!-- Top Statistics -->
        <div class="row justify-content-center">
            <div class="col-lg-11 mb-5">
                <div class="row mt-4">
                    <div class="col-lg-12 col-lg-offset-2">
                        <div class="left-news">
                            <h2 class="font-weight-bold text-center">
                                <font color="#146C94">&nbsp; Add Student</font>
                            </h2>
                            <h6 class="fw-bold">InternshipTime</h6>
                        </div>
                    </div>
                </div>

                <div class="border border-top-3 border-danger">
                    <div class="panel grey lighten-5 border ">
                        <h6 class="font-weight-normal pt-1 pl-1">Info : Fill Up Details</h6>
                        <hr>
                        <div class="panel-body p-4">

                            <form action="" method="post" autocomplete="off" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col-lg-4">
                                        <div class="form-group ">
                                            <label>Student Name</label>
                                            <input class="form-control" type="text" name="name" placeholder="Enter Teacher Name" required="required" style="" />
                                        </div>
                                        <!--form-group-->
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group ">
                                            <label>Email</label>
                                            <input class="form-control tt" type="email" name="email" placeholder="Enter teacher email" required="required" />
                                        </div><!--form-group-->
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group ">
                                            <label>Phone number</label>
                                            <input class="form-control tt" type="number" name="phone_number" placeholder="Enter phone number" min="10" max="10" required="required" />
                                        </div><!--form-group-->
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <button type="submit" name="post" class="btn btn-danger">ADD</button>
                                </div>
                        </div>
                        </form>
                        <!--form1-->

                    </div>
                </div>
            </div>
            <!--6-->
        </div>
        <!--row2-->
        <!--/body-->
    </div>
</div>
</div>


<?php include_once("include1/footer.php"); ?>

<?php
if (isset($_GET['a'])) {
    if ($_GET['a'] == 1) {
        ?>
        <script>
            alert("Teacher Profile is successfully added..");
        </script>
<?php
    }
}
?>
<?php
ob_flush();
?>
